---
title: "Final Project"
author: "Colleen Burke"
date: "2025-12-02"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
library(purrr)
library(sandwich)
library(knitr)
library(broom)

set.seed(12345)
```


# Background

Generalized linear models (GLMs) extend ordinary regression to non-normal outcomes.  
This project evaluates how model **misspecification** (fitting a Normal model to Poisson data) affects:

- Bias of λ̂  
- Variance of β̂  
- Naïve vs robust variance estimates  
- Differences by sample size and true λ  

We simulate Poisson outcomes using fixed binary predictors and compare Normal vs Poisson regression.

# Methods

## Load x-vectors

```{r load-x}
x20  <- read_csv("x_n20-1.csv") |> pull(x)
x200 <- read_csv("x_n200.csv")   |> pull(x)

length(x20)
length(x200)
```



## Simulation Functions

```{r sim-functions}

simulate_data <- function(N, lambda, x_vector) {
  x_vector <- as.numeric(x_vector)
  N_x <- length(x_vector)
  
  if (N_x != N) {
    stop("Length mismatch: x length = ", N_x, " but N = ", N)
  }
  
  tibble(
    x = x_vector,
    y = rpois(N_x, lambda)
  )
}

run_one_sim <- function(N, lambda, x_vector) {
  
  dat <- simulate_data(N, lambda, x_vector)
  
  fit_pois <- glm(y ~ x, family = poisson, data = dat)
  fit_norm <- glm(y ~ x, family = gaussian, data = dat)
  
  new_data <- data.frame(x = x_vector)
  
  pois_lambda_hat <- predict(fit_pois, newdata = new_data, type = "response")
  norm_lambda_hat <- predict(fit_norm, newdata = new_data, type = "response")
  
  pois_bias <- mean(pois_lambda_hat - lambda)
  norm_bias <- mean(norm_lambda_hat - lambda)
  
  naive_pois  <- vcov(fit_pois)[2,2]
  robust_pois <- sandwich(fit_pois)[2,2]
  
  naive_norm  <- vcov(fit_norm)[2,2]
  robust_norm <- sandwich(fit_norm)[2,2]
  
  tibble(
    N = N,
    lambda = lambda,
    pois_bias = pois_bias,
    norm_bias = norm_bias,
    naive_pois = naive_pois,
    robust_pois = robust_pois,
    naive_norm = naive_norm,
    robust_norm = robust_norm,
    beta1_pois = coef(fit_pois)[2],
    beta1_norm = coef(fit_norm)[2]
  )
}
```

## Run Simulations

```{r run-sims}
Ns <- c(20, 200)
lambdas <- c(4, 10)
B <- 2000

results_list <- list()

for (N in Ns) {
  
  x_vec <- if (N == 20) x20 else x200
  
  for (lambda in lambdas) {
    res <- map_dfr(1:B, ~ run_one_sim(N, lambda, x_vec))
    results_list[[paste0("N", N, "_lambda", lambda)]] <- res
  }
}

all_results <- bind_rows(results_list, .id = "scenario")
```



# Results

## Bias of λ̂

```{r bias-table}
bias_table <- all_results |>
  group_by(N, lambda) |>
  summarise(
    mean_pois_bias = mean(pois_bias),
    mean_norm_bias = mean(norm_bias),
    .groups = "drop"
  )

knitr::kable(bias_table, digits = 4,
             caption = "Average Bias of λ̂ Across Scenarios")
```



## Variances of β̂ (Naïve vs Robust)

```{r var-table}
var_table <- all_results |>
  group_by(N, lambda) |>
  summarise(
    naive_norm  = mean(naive_norm),
    robust_norm = mean(robust_norm),
    naive_pois  = mean(naive_pois),
    robust_pois = mean(robust_pois),
    .groups = "drop"
  )

knitr::kable(var_table, digits = 5,
             caption = "Naïve and Robust Variances of β̂₁")
```


## Confidence Intervals for β̂₁

```{r ci-data}
ci_summary <- all_results |>
  group_by(N, lambda) |>
  summarise(
    beta_mean_pois  = mean(beta1_pois),
    se_naive_pois   = sqrt(mean(naive_pois)),
    se_robust_pois  = sqrt(mean(robust_pois)),
    beta_mean_norm  = mean(beta1_norm),
    se_naive_norm   = sqrt(mean(naive_norm)),
    se_robust_norm  = sqrt(mean(robust_norm)),
    .groups = "drop"
  )

ci_summary <- bind_rows(
  ci_summary |>
    transmute(
      N, lambda,
      model   = "Poisson",
      var_type = "Naive",
      beta    = beta_mean_pois,
      se      = se_naive_pois
    ),
  ci_summary |>
    transmute(
      N, lambda,
      model   = "Poisson",
      var_type = "Robust",
      beta    = beta_mean_pois,
      se      = se_robust_pois
    ),
  ci_summary |>
    transmute(
      N, lambda,
      model   = "Normal",
      var_type = "Naive",
      beta    = beta_mean_norm,
      se      = se_naive_norm
    ),
  ci_summary |>
    transmute(
      N, lambda,
      model   = "Normal",
      var_type = "Robust",
      beta    = beta_mean_norm,
      se      = se_robust_norm
    )
) |>
  mutate(
    lower = beta - 1.96 * se,
    upper = beta + 1.96 * se
  )
```


```{r ci-plot, fig.width=8, fig.height=6}
ggplot(ci_summary,
       aes(x = model, y = beta, ymin = lower, ymax = upper,
           color = var_type)) +
  geom_pointrange(position = position_dodge(0.4)) +
  facet_grid(lambda ~ N, labeller = label_both) +
  labs(
    title = "95% Confidence Intervals for β₁",
    y = "Estimate",
    x = "Model",
    color = "Variance Type"
  ) +
  theme_minimal()
```

# Conclusions





Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
